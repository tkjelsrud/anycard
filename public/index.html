<html>
<head>
  <style>
    body {
      margin: 0;
      background-color: #F0F3BD;
      font-family: Verdana;
    }
    .toolbar {
      float: left;
      background-color: #F0E6EF;
      padding: 2px;
      width: 100%;
      border-bottom: 1px solid grey;
    }
    #avatar {
      float: left;
      height: 32px;
      width: 32px;
    }
    #avatar img {
      height: 32px;
      width: 32px;
    }
    .page {
      float: left;
      background-color: #F0F3BD;
      width: 100%;
    }
    .card {
      position: absolute;
      width: 130px;
      height: 120px;
      display: block;
      background-color: #FCBF49;
      border: 1px solid grey;
      box-shadow: 4px 4px 4px #CCCCCC;
      vertical-align: middle;
    }
    .card .head {
      float: left;
      background-color: #F0E6EF;
      height: 30px;
      width: 100%;
    }
    .card .head img {
      height: 32px;
      width: 32px;
    }
    .card .text {
      float: left;
      height: 70%;
      width: 94%;
      padding: 4px;
      font-size: 12px;
    }

    .icon {
      float: left;

    }
    .icon img {
      width: 48px;
      height: 48px;
    }
  </style>
</head>
<body>
  <!-- ... other HTML ... -->

  <!-- IDEAS

  colorize icons pr participant using

  filter: contrast(100) saturate(1000) hue-rotate(270deg)

  -->

  <!-- Load React. -->
  <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
  <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
  <script src="js/util.js"></script>
  <!-- Load our React component. -->
  <!--script src="js/card.js"></script>
  <script src="js/dice.js"></script -->
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
  <script type="text/javascript">
    var user = {uuid: 0, bid: 0, color: 1, icon: 1, unloaded: true};

    function getCookie(name) {
      var value = "; " + document.cookie;
      var parts = value.split("; " + name + "=");
      if (parts.length == 2) return parts.pop().split(";").shift();
    }
    //var socket = io('http://172.105.95.145:8081');
    //var io = require('socket.io-client');
    var socket = io('http://localhost:8081');

    function login(uuid, bid) {
      // Process data and create board
      // console.log(data);

      socket.emit('message', JSON.stringify({type:'LOGIN', uuid: uuid, bid: bid}));
    }

    function createColor(index) { 
      c = new Array("#264653", "#2A9D8F", "#E9C46A", "#F4A261", "#E76F51", "#F4ACB7", "#9D8189", "#FF595E", "#8AC926", "#1982C4");
      if(index >= c.length)
        index = index & c.length;

      return c[index];
    }

    function createIcon(index) {
      img = document.createElement("img");
      img.src = "img/food" + index + ".png";

      return img;
    }

    function createCard(card) {
      div = document.createElement("div");
      div.id = card.id;
      div.className = "card";
      div.contentEditable = "false";

      divH = document.createElement("div");
      divH.id = card.id + "h";
      divH.className = "head";
      divH.innerHtml = "&nbsp;";
      divH.contentEditable = "false";
      divH.style.backgroundColor = createColor(card.color);

      img = createIcon(card.icon);
      divH.appendChild(img);

      divT = document.createElement("div");
      divT.className = "text";
      divT.innerText = card.text;
      divT.contentEditable = "true";
      divT.onblur = function() { cardText(event); };

      div.appendChild(divH);
      div.appendChild(divT);

      return div;
    }

    socket.on('message', (data) => {
      msg = JSON.parse(data);
      console.log(msg);

      switch(msg.type) {
        case "NEWCARD":
          console.log("new card from server");
          console.log(msg.card);
          page = document.getElementsByClassName("page")[0];
          page.appendChild(createCard(msg.card));

          card = document.getElementById(msg.card.id);
          card.style.left = msg.card.x + "px";
          card.style.top = msg.card.y + "px";

          dragElement(card);

          break;

        case "MOVE":
          console.log("Trying to move card" + msg.card.id);
          card = document.getElementById(msg.card.id);
          card.style.left = msg.card.x + "px";
          card.style.top = msg.card.y + "px";
          break;

        case "TEXT":
          console.log("Trying to set text" + msg.card.id);
          card = document.getElementById(msg.card.id);
          card.children[1].innerText = msg.card.text;

        case "LOGIN":
          user = msg.user;
          console.log(user);
          ava = document.getElementById("avatar");
          ava.style.backgroundColor = createColor(user.color);
          img = createIcon(user.icon);
          ava.appendChild(img);

          break;
      }
    });

    function cardMoved(id) {
      card = document.getElementById(id);
      const msg = {type:'MOVE', bid: user.bid, id: id, x: parseInt(card.style.left), y: parseInt(card.style.top)};

      socket.emit('message', JSON.stringify(msg));
    }

    function cardText(e) {
      e = e || window.event;
      text = e.target.innerText;
      const msg = {type:'TEXT', bid: user.bid, id: e.target.parentNode.id, text: text};
      socket.emit('message', JSON.stringify(msg));
    }

    function addCard() {
      // I don't add a card myself, the server tells me a new card appeared
      //
      const msg = {type:'NEWCARD', bid: user.bid, owner: user.uuid, color: user.color, icon: user.icon};

      socket.emit('message', JSON.stringify(msg));
      /*
      var node = document.createElement("div");
      node.className = "card";
      node.id = Math.random();
      document.querySelector('#card_container').appendChild(node);*/
    }
    function changeIcon(idx, cdx) {
      icons = document.getElementsByClassName('icon')[0];
      icons.innerHTML = "";
      icons.style.backgroundColor = createColor(cdx);
      icons.appendChild(createIcon(idx));
    }

    window.addEventListener('load', function() {
      var urlParams = new URLSearchParams(window.location.search);

      uuid = 0;
      if(getCookie("uuid")) {
        uuid = getCookie("uuid");
      }

      bid = uuid;
      if(urlParams.has('bid')) {
        bid = urlParams.get('bid');
      }

      login(uuid, bid);
    });
  </script>

  <div class="toolbar"><div id="avatar"></div> | <a href="#" onclick="void(addCard());">Add card</a></div>
  <div class="page">&nbsp;</div>
  <div id="hmm">
    <div class="icon">&nbsp;</div>
  </div>
</body>
</html>
